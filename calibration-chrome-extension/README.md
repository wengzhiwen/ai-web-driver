# 标定工具 - Chrome插件版 v0.1.1 🚀

基于Chrome Extension Manifest V3的页面元素打标工具，支持DOM树浏览、元素高亮、候选选择器生成、本地导出Site Profile JSON。

## ✨ 功能特性

### 🎯 核心功能
- **页面内打标**: Alt+P快捷键切换标注模式，直接点击页面元素记录标注
- **侧边面板**: 展示DOM树结构，支持点击高亮、双击添加标注
- **智能选择器生成**: 自动生成优先级排序的CSS候选选择器（基于唯一性算法）
- **本地持久化**: 基于Chrome Storage API，按页面URL分组存储标注数据
- **数据导出**: 一键导出标准化的Site Profile JSON文件

### ⚡ 性能优化 (v0.1.1新增)
- **分批渲染**: 支持大型页面的DOM树渲染，避免界面卡顿
- **懒加载**: 按需加载子节点，提高初始加载速度
- **智能节流**: 鼠标移动事件优化，减少CPU使用
- **内存管理**: 完善的事件清理和内存释放机制
- **智能过滤**: 自动过滤script、style等不相关节点，保持DOM树清洁

### 📄 页面级别管理 (v0.1.1新增)
- **页面隔离**: 标注列表按页面分组，清晰显示当前页面标注
- **智能导出**: 支持单页面导出和全站导出两种模式
- **文件命名**: 自动生成包含域名和时间的唯一文件名
- **实时统计**: 显示当前页面URL和标注数量信息

### 🎨 用户体验 (v0.1.1新增)
- **平滑动画**: 高亮框过渡效果和tip提示动画
- **视觉反馈**: hover效果和状态指示
- **主题适配**: 支持深色模式和高对比度模式
- **调试信息**: 鼠标悬停显示元素详细信息

### 🔧 技术特点
- **零依赖**: 纯原生JavaScript实现，无需外部库
- **高性能**: DOM树裁剪快照 + 懒加载机制
- **跨框架**: 支持多框架页面切换查看
- **响应式**: 适配不同屏幕尺寸的侧边面板

## 安装使用

### 安装步骤
1. 打开Chrome浏览器，访问 `chrome://extensions`
2. 右上角开启**开发者模式**
3. 点击**"加载已解压的扩展程序"**
4. 选择本项目文件夹 `calibration-chrome-extension`
5. 固定扩展图标，点击扩展图标打开侧边面板

### 使用方法
1. **开启标注模式**: 点击侧边面板"开启标注"按钮，或使用快捷键 `Alt+P`
2. **页面打标**: 在标注模式下，直接点击页面元素即可记录标注
3. **DOM树浏览**: 左侧面板展示页面DOM结构
   - **单击节点**: 在页面中高亮对应元素
   - **双击节点**: 将该元素添加到标注列表
4. **页面级别标注管理**: 右侧面板只显示当前页面的标注
   - 实时显示当前页面URL和标注数量
   - 支持编辑描述、删除、高亮元素
   - 每个标注显示详细的元素指纹信息
5. **分层导出功能**:
   - **导出当前页**: 只导出当前页面的标注数据
   - **导出所有页面**: 导出所有已标注页面的完整数据
   - 自动生成带域名和时间戳的文件名

## 界面说明

### 侧边面板布局
```
┌───────────────────────────────────────────────┐
│ 头部：标注模式切换 | 当前页面URL              │
├─────────────────┬─────────────────────────────┤
│ DOM树结构       │ 当前页面标注 (页面级别)       │
│ • 过滤搜索      │ • 页面信息和标注数量         │
│ • 刷新按钮      │ • 元素指纹详情              │
│ • 树形展示      │ • 候选选择器预览             │
│                │ • 描述编辑                 │
│                │ • 高亮/删除操作             │
├─────────────────┴─────────────────────────────┤
│ 底部：工具栏 (导出当前页 | 导出所有页 | 清空)    │
└───────────────────────────────────────────────┘
```

### 快捷键
- `Alt+P`: 开启/关闭标注模式
- `鼠标点击`: 标注模式下记录元素
- `双击DOM节点`: 快速添加标注

### 🚫 智能节点过滤 (v0.1.1新增)
为了提供更清洁的DOM树视图，插件会自动过滤以下节点：
- **`<script>`**: JavaScript脚本标签
- **`<style>`**: 内联样式标签
- **`<link>`**: 外部资源链接标签
- **`<meta>`**: 元数据标签
- **`<noscript>`**: 无脚本内容标签

**优势**：
- 减少DOM树复杂度，提高浏览效率
- 聚焦于可交互的页面元素
- 显著提升大型页面的渲染性能
- 过滤后的节点数量会在统计信息中显示

**统计信息示例**：
```
页面统计: 可见节点: 1,234 | 总节点数: 2,856 | 最大深度: 12 | 当前URL: example.com
```

## 数据格式

### 标注数据结构 (v0.1.3更新 - site_profiles标准格式)
```json
{
  "version": "20251018T143000Z",
  "pages": [
    {
      "id": "products",
      "name": "example.com-products",
      "url_pattern": "/products/123",
      "version": "20251018T143000Z",
      "generated_at": "20251018T143000Z",
      "generated_by": "chrome_extension_manual",
      "aliases": {
        "element_1": {
          "selector": "[data-testid=\"add-to-cart\"]",
          "description": "加入购物车按钮 - 主要购买按钮",
          "role": "按钮",
          "confidence": 0.8
        },
        "element_2": {
          "selector": "input[type=\"text\"]#search",
          "description": "搜索输入框",
          "role": "文本输入框",
          "confidence": 0.8
        }
      }
    }
  ]
}
```

### 字段说明 (v0.1.3更新)
- `version`: 导出版本号（格式：YYYYMMDDTHHMMSSZ）
- `pages[]`: 页面列表
  - `id`: 页面唯一标识（基于URL路径生成）
  - `name`: 页面名称（基于域名和路径生成）
  - `url_pattern`: 页面URL模式
  - `version`: 页面版本号
  - `generated_at`: 生成时间
  - `generated_by`: 生成方式（"chrome_extension_manual"）
  - `aliases`: 元素别名映射
    - `element_N`: 元素别名（N从1开始编号）
      - `selector`: 推荐CSS选择器
      - `description`: 用户描述（可编辑）
      - `role`: 元素角色（按钮、链接、输入框等，由系统自动推断）
      - `confidence`: 置信度（默认0.8）

## 技术架构

### 文件结构
```
calibration-chrome-extension/
├── manifest.json          # 扩展配置文件
├── content-script.js      # 页面注入脚本
├── background.js          # 后台服务工作者
├── sidepanel.html         # 侧边面板页面
├── sidepanel.js           # 侧边面板逻辑
├── overlay.css            # 高亮层样式
├── icons/                 # 扩展图标目录
└── README.md             # 说明文档
```

### 核心组件
1. **Content Script**: 页面内元素识别、高亮、事件处理
2. **Background Service Worker**: 数据存储、消息路由、文件下载
3. **Side Panel**: DOM树展示、标注管理、用户界面

### 通信机制
- `Content Script ↔ Background`: 消息传递，保存/获取标注数据
- `Side Panel ↔ Background`: 请求页面数据、标注信息
- `Side Panel ↔ Content Script`: DOM操作指令（高亮、添加标注）

## 浏览器兼容性

### 支持版本
- **Chrome**: ≥ 114（支持Side Panel API）
- **Edge**: ≥ 114（API兼容性需验证）

### 受限页面
扩展无法在以下页面中工作：
- `chrome://*` 系统页面
- Chrome Web Store
- 系统PDF查看器
- CSP严格限制的页面

## 性能优化

### DOM树处理
- 限制快照深度（3层）和广度（每层60子节点）
- 懒加载和按需展开子树
- 防抖处理用户输入
- **智能节点过滤**: 自动过滤script、style等不相关节点，大幅减少DOM树大小

### 事件处理
- 使用`requestAnimationFrame`优化鼠标移动事件
- 消息节流避免频繁通信
- 复用DOM元素减少重排重绘

## 安全性

### 数据隐私
- 仅本地存储，不向网络发送任何数据
- 导出需用户显式触发
- 避免采集敏感HTML内容

### 权限最小化
- `scripting`: 注入content script
- `tabs`: 获取当前标签页信息
- `storage`: 本地数据存储
- `downloads`: 文件导出
- `webNavigation`: 框架信息获取

## 故障排除

### 常见问题
1. **侧边面板无法打开**: 确保Chrome版本≥114
2. **页面内无响应**: 检查是否为受限页面（如chrome://）
3. **标注丢失**: 刷新页面后数据应保持，检查存储权限
4. **导出失败**: 确保浏览器允许文件下载
5. **需要初始化插件**: v0.1.1+版本采用手动注入机制，更稳定可靠

### Content Script初始化 (v0.1.1新增)
某些情况下需要手动初始化content script：
- 页面刚加载完成时
- 浏览器重启后首次使用
- 页面使用复杂安全策略时

**初始化步骤**：
1. 打开侧边面板
2. 如看到"需要初始化插件"提示，点击"初始化插件"按钮
3. 等待初始化完成（显示✓成功）
4. DOM树将自动加载

**优势**：
- ✅ 更稳定的注入机制
- ✅ 减少自动注入冲突
- ✅ 明确的初始化反馈
- ✅ 用户可控的初始化时机

### 调试方法
1. 打开Chrome开发者工具
2. 查看Console面板的错误信息
3. 在扩展管理页面检查详细信息

## 开发说明

### 本地开发
1. 修改代码后，在扩展管理页面点击刷新按钮
2. 重新加载页面以加载最新的content script
3. 打开开发者工具查看调试信息

### 自定义配置
- **DOM深度限制**: 修改`content-script.js`中的`maxDepth`参数
- **选择器优先级**: 调整`generateCssCandidates`函数逻辑
- **导出格式**: 修改`background.js`中的`prepareExportData`函数

## 更新日志

### v0.1.9 (2025-10-18) - 标注界面简化 ✨
- 🗑️ **移除冗余信息**: 移除标注项的时间戳和编号显示
- ✨ **简化界面结构**: 标注列表更简洁，专注于元素信息本身
- 🎯 **突出核心内容**: 元素指纹、选择器和描述更加突出
- 🧹 **代码清理**: 移除不再使用的时间格式化代码
- 📱 **提升用户体验**: 减少视觉干扰，让用户专注于标注内容

### v0.1.8 (2025-10-18) - DOM加载能力大幅提升 📊
- 🚀 **大幅提升加载参数**: 深度提升至15层，节点数提升至2000个
- 📈 **优化默认配置**: 默认maxDepth=15，maxChildren=500，支持更复杂的页面结构
- 🌳 **减少折叠限制**: 折叠深度从4层提升至6层，预加载深度从3层提升至5层
- 🔍 **增强搜索覆盖面**: 更多的DOM节点意味着搜索功能更强大和实用
- ⚡ **性能优化**: 在保证性能的前提下，提供更完整的DOM树视图

### v0.1.7 (2025-10-18) - 搜索功能增强 🔍
- 🔍 **增强搜索功能**: 支持搜索元素的inner text、value属性、placeholder等
- 📄 **智能文本搜索**: 优先搜索文本内容，提升查找效率
- ⚡ **提升初始加载**: 默认加载深度10层，节点数1000个，让搜索更有意义
- 🎯 **属性优先级**: 优先搜索value、placeholder、title、name等常用属性
- 💡 **更新提示文本**: 搜索框提示改为"搜索文本、value、属性名..."

### v0.1.6 (2025-10-18) - 界面简化 🎨
- 🗑️ **移除多余按钮**: 移除"全部展开"、"全部折叠"、"加载更多"按钮
- 🧹 **代码清理**: 删除相关的事件处理器和JavaScript代码
- ✨ **简化界面**: 保留核心功能，让界面更简洁易用
- 🎯 **聚焦核心**: 专注于DOM浏览、元素标注和导出功能

### v0.1.5 (2025-10-18) - 导出功能修复 📤
- 🐛 **修复消息路由错误**: 解决"未知消息类型"错误，统一download_export消息处理
- 🔧 **修复Service Worker兼容性**: 使用Data URL替代Blob URL，解决Manifest V3兼容性问题
- 🧹 **代码重构**: 移除重复的消息监听器，统一导出逻辑
- ✅ **确保导出正常**: 修复导出按钮点击无响应和下载失败问题

### v0.1.4 (2025-10-18) - 初始化错误修复 🐛
- 🐛 **修复核心元素验证错误**: 解决"核心DOM元素缺失: exportAllBtn"初始化失败问题
- 🔧 **同步元素验证列表**: 更新核心元素检查列表，移除已删除的exportAllBtn引用
- ✅ **确保正常启动**: 修复侧边面板无法初始化的问题

### v0.1.3 (2025-10-18) - 导出格式优化 📤
- 📄 **导出格式标准化**: 修改导出格式符合site_profiles标准格式，支持aliases结构
- 🎯 **简化导出功能**: 移除"导出所有页面"功能，专注当前页面导出
- 🔧 **智能角色推断**: 根据HTML标签自动推断元素角色（按钮、链接、输入框等）
- 📝 **智能页面命名**: 基于URL路径自动生成页面ID和页面名称
- 🗂️ **版本号标准化**: 采用site_profiles标准的版本号格式(YYYYMMDDTHHMMSSZ)
- 🎨 **界面简化**: 移除多余的导出按钮，简化界面布局

### v0.1.2 (2025-10-18) - DOM绑定错误修复 🔧
- 🐛 **修复DOM元素绑定错误**: 解决"Cannot set properties of undefined"错误
- 🔧 **重构事件绑定机制**: 将所有事件绑定移至`bindEventListeners()`函数，确保在DOM加载完成后执行
- 🛡️ **增强错误处理**: 添加详细的初始化日志和错误反馈机制
- ✅ **验证机制优化**: 在绑定事件前验证DOM元素是否存在，避免空指针错误
- 📊 **调试信息增强**: 添加事件绑定过程的详细日志输出
- 🔍 **元素初始化改进**: 重构`initializeElements()`函数，支持元素缺失检测和错误报告

### v0.1.1 (2025-10-18) - 重大优化更新 🔧
- 🐛 **修复DOM树渲染问题**: 解决节点重复显示和渲染逻辑错误
- ⚡ **性能大幅提升**: 重构DOM树渲染，支持分批渲染和懒加载
- 🎯 **智能选择器算法**: 基于唯一性和优先级的选择器生成
- 🚫 **智能节点过滤**: 自动过滤script、style等不相关节点，保持DOM树清洁
- 🔌 **稳定注入机制**: 优化content script注入，采用手动初始化更可靠
- 📄 **页面级别管理**: 标注列表按页面分组，支持单页面和全站导出
- 🎨 **视觉效果增强**: 添加平滑动画、hover效果和主题适配
- 🔧 **交互功能优化**: 改进点击、双击事件处理，防止冲突
- 🛡️ **错误处理完善**: 增加降级机制和异常捕获
- 📊 **调试信息增强**: 丰富的控制台日志和可视化反馈
- 🌙 **主题支持**: 深色模式和高对比度模式适配

### v0.1.0 (2025-10-15) - 初始版本 🎉
- ✨ 初始版本发布
- 🎯 实现MVP核心功能
- 🔧 支持Alt+P快捷键标注
- 📊 DOM树浏览和过滤
- 💾 本地数据持久化
- 📤 Site Profile JSON导出
- 🎨 现代化侧边面板界面

### 已知问题修复历史
- ❌ ~~DOM树节点重复显示~~ ✅ 已修复 (v0.1.1)
- ❌ ~~点击/双击无响应~~ ✅ 已修复 (v0.1.1)
- ❌ ~~大型页面卡顿~~ ✅ 已优化 (v0.1.1)
- ❌ ~~选择器不准确~~ ✅ 已改进算法 (v0.1.1)
- ❌ ~~高亮位置偏移~~ ✅ 已修正定位逻辑 (v0.1.1)
- ❌ ~~自动注入不稳定~~ ✅ 已改为手动初始化机制 (v0.1.1)
- ❌ ~~DOM元素绑定错误~~ ✅ 已修复 (v0.1.2)

## 贡献指南

欢迎提交Issue和Pull Request来改进工具功能。

### 开发环境
- Node.js（可选，用于构建工具）
- Chrome浏览器（≥114版本）
- 代码编辑器（推荐VS Code）

### 提交规范
- feat: 新功能
- fix: 问题修复
- docs: 文档更新
- style: 代码格式调整
- refactor: 代码重构
- test: 测试相关
- chore: 构建/工具相关

## 许可证

本项目采用MIT许可证，详见LICENSE文件。