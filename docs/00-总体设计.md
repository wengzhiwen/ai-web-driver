0. 总体描述（Overall）

0.1 目标
	•	免代码：QA 通过自然语言/表单即可编写用例。
	•	低成本：运行期全本地；仅在“编译/标定”阶段按需使用外部 LLM。
	•	可回放：失败可一键回溯（Trace Viewer），定位问题无需复现现场。
	•	可维护：站点 Profile（页面/元素/别名/跳转条件）集中管理与版本化。

0.2 非目标（当前阶段）
	•	不做“自治代理式”运行期决策（运行期不让 LLM 介入）。
	•	不做跨站泛化爬测；只服务被测站点（白名单域）。

0.3 核心数据流

TestRequest(自然语言/DSL)
        │
        ├──[编译器/LLM]──► ActionPlan(强类型 DSL JSON)
        │                          │
SiteProfile(标定/别名/定位器) ─────┘
                                   │
                          [执行器/Playwright MCP]
                                   │
                   Trace.zip + 运行明细(SQLite/Artifacts)
                                   │
                         [报告查看器/Trace Viewer]

0.4 关键技术选择
	•	执行：Playwright + MCP Server（本地）。
	•	标定：Playwright Inspector/Codegen + A11y 树 + axe 扫描。
	•	模型：本地 7B（运行期不用）；外部 LLM 仅在“一次性标定/用例编译”可选。
	•	存储：SQLite（Profile/运行结果/工件索引）。

0.5 安全/合规
	•	域名白名单、禁止跨域导航；敏感字段脱敏写入 Trace/日志。
	•	禁止页面向“代理/模型”下指令（Prompt Injection 防护），运行期无模型更安全。

0.6 质量指标（初版）
	•	用例稳定率（7 天内无非功能性失败）≥ 98%。
	•	选择器健康度：role/label/testId 覆盖率 ≥ 90%。
	•	Trace 可复盘覆盖率（失败用例生成 trace）= 100%。

0.7 MVP 范围
	•	标定基本流程、别名管理、用例→DSL 编译、执行、报告+Trace 链接。

⸻

1. 模块一：标定工具（Profile Builder）

1.1 核心功能
	•	入口/发现：手动添加 URL；可读取 sitemap.xml 进行初始发现。
	•	页面预览：在 iframe 中加载页面，支持点选取元素（联动高亮）。
	•	DOM/A11y 面板：展示可访问性树、关键属性（role/name/label/testId）。
	•	自动标定草稿：
	•	启动浏览器→提取 A11y 树→运行 axe 扫描→生成元素候选与说明摘要。
	•	结合 Codegen/Inspector 输出的稳定定位器建议。
	•	手动精修：给元素设置 alias、类型（button/input/price/toast…）、操作能力（click/fill/select…）。
	•	跳转关系：记录 edges（from→to），支持条件（登录态、用户类型、表单有效等）。
	•	历史映射：加载历史 Profile，尝试匹配到当前 DOM，显示“✅匹配/⚠️模糊/❌失配”。
	•	一键校验：验证每个 alias 的定位器是否唯一命中（count()==1），失败给出截图与建议。
	•	版本化：meta.version + 变更日志（新增/修改/删除元素、跳转）。

1.2 数据模型（SiteProfile 简版）

{
  "meta": {"baseUrl": "https://shop.example.com", "version": "v1"},
  "pages": [
    {
      "id": "login",
      "urlPattern": "/login",
      "summaryCN": "买家登录页：包含邮箱、密码与登录按钮；成功后跳转首页。",
      "elements": [
        {"alias": "login.email",   "type": "textbox", "by": {"role":"textbox","name":"邮箱"}},
        {"alias": "login.password", "type": "textbox", "by": {"role":"textbox","name":"密码"}},
        {"alias": "login.submit",  "type": "button",  "by": {"role":"button","name":"登录"}}
      ],
      "edges": [
        {"to":"home", "via":"click(login.submit)", "cond":"auth.success"}
      ]
    }
  ]
}

1.3 SQLite 结构（建议）

-- profile 元信息
CREATE TABLE profiles(
  id INTEGER PRIMARY KEY, name TEXT, base_url TEXT, version TEXT,
  created_at TEXT, updated_at TEXT
);
-- 页面
CREATE TABLE pages(
  id INTEGER PRIMARY KEY, profile_id INTEGER, page_id TEXT, url_pattern TEXT,
  summary_cn TEXT, FOREIGN KEY(profile_id) REFERENCES profiles(id)
);
-- 元素（别名）
CREATE TABLE elements(
  id INTEGER PRIMARY KEY, profile_id INTEGER, page_id TEXT,
  alias TEXT, type TEXT,
  by_role TEXT, by_name TEXT, by_testid TEXT, by_css TEXT,
  UNIQUE(profile_id, page_id, alias)
);
-- 跳转
CREATE TABLE edges(
  id INTEGER PRIMARY KEY, profile_id INTEGER, from_page TEXT, to_page TEXT,
  via TEXT, cond TEXT
);

1.4 关键交互/验证
	•	拾取定位器：集成 Playwright Inspector/Codegen（点击目标→回填定位器）。
	•	高亮联动：外部 DOM 面板选中元素 → iframe 内绘制遮罩框；反向亦然。
	•	可测性提示：缺 label/role 的元素打红点，建议补 aria-label 或 data-testid。

1.5 错误与边界
	•	SPA 路由与登录态：支持 storageState 预置，或设置“前置动作”后再标定。
	•	动态列表：允许 alias 模板（如 cart.items[i].title），并提供匹配谓词（包含文本/属性）。

⸻

2. 模块二：用例→指令生成器（编译器）

2.1 输入
	•	TestRequest：自然语言或轻量 DSL（Given/When/Then/数据表）。
	•	SiteProfile：页/元素/别名/边。

2.2 输出：ActionPlan DSL（强类型）

{
  "meta": {"testId": "TC-Checkout-001", "baseUrl": "https://shop.example.com"},
  "steps": [
    {"t":"goto",  "url":"/login"},
    {"t":"fill",  "alias":"login.email",    "value":"qa@example.com"},
    {"t":"fill",  "alias":"login.password", "value":"pass1234"},
    {"t":"click", "alias":"login.submit"},
    {"t":"goto",  "url":"/cart"},
    {"t":"assert","kind":"visible", "alias":"cart.heading"},
    {"t":"assert","kind":"text_regex", "alias":"cart.totalPrice","pattern":"^¥\\s?\\d+[.,]?\\d*$"}
  ]
}

断言种类（建议内置）
	•	visible/invisible/enabled/disabled
	•	text_equals/text_contains/text_regex
	•	count_equals/count_at_least
	•	attr_equals/attr_contains
	•	http_ok（图片/资源响应 200）

2.3 约束与校验
	•	JSON Schema + 运行前静态校验（字段必填、别名存在、URL 合法）。
	•	不允许 执行期调用 LLM；编译阶段可用本地/外部模型，失败重试 N 次。

2.4 接口形态
	•	CLI：compile -i request.md -p profile.json -o plan.json
	•	HTTP：POST /compile {profile, request} → plan.json

⸻

3. 模块三：测试执行器（Playwright MCP）

3.1 行为
	•	读取 ActionPlan，将 alias 解析为 Locator（优先级：getByRole/name/label → getByTestId → css/xpath）。
	•	自动等待/重试：使用 Locator 内置等待（可配置超时）。
	•	storageState 支持：登录前置或多账号切换。
	•	并发：worker 池 + 用例隔离的 context。

3.2 Trace & 工件
	•	失败留证据策略：on-first-retry 或 retain-on-failure。
	•	每次运行产出：trace.zip、step 截图、console.log、network 摘要。
	•	写入 SQLite：run_id、case_id、status、开始/结束、失败原因、trace 路径、关键指标。

3.3 配置项（示例）

{
  "baseUrl": "https://shop.example.com",
  "headless": true,
  "testIdAttribute": "data-pw",
  "timeoutMs": 15000,
  "retries": 1,
  "tracePolicy": "on-first-retry",
  "allowedHosts": ["shop.example.com"],
  "maskFields": ["password","token","creditCard"]
}

3.4 错误处理
	•	定位器 0 命中：截屏 + DOM 片段存档 + 提示最近似候选。
	•	多命中：引导收紧定位（增加 hasText 等）。
	•	网络失败：记录请求/响应摘要，支持重试/跳过策略。

⸻

4. 模块四：结果/报告查看器

4.1 视图
	•	运行列表：按时间/用例/标签过滤，显示通过率、平均耗时、失败原因 TopN。
	•	用例详情：步骤时间线、断言结果、截图缩略图、console/network 摘要。
	•	Trace 快捷入口：点击打开 trace.zip（调用本地 npx playwright show-trace 或嵌入静态 Viewer 页）。
	•	Profile 变更对比：展示本次运行引用的 Profile 版本与差异。

4.2 数据来源
	•	SQLite：runs、run_steps、artifacts。
	•	文件系统：trace/、screenshots/、logs/。

4.3 产物打包
	•	导出 run_bundle.zip（包含报告 HTML、trace、截图、最小复现实例）。

⸻

5. 跨模块“接口契约”

5.1 ActionPlan JSON Schema（概要）

{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "type": "object",
  "required": ["meta","steps"],
  "properties": {
    "meta": {"type":"object","properties":{"testId":{"type":"string"},"baseUrl":{"type":"string"}}},
    "steps": {
      "type":"array",
      "items": {
        "type":"object",
        "oneOf": [
          {"properties": {"t":{"const":"goto"},   "url":{"type":"string"}}, "required":["t","url"]},
          {"properties": {"t":{"const":"click"},  "alias":{"type":"string"}}, "required":["t","alias"]},
          {"properties": {"t":{"const":"fill"},   "alias":{"type":"string"},"value":{"type":"string"}}, "required":["t","alias","value"]},
          {"properties": {"t":{"const":"assert"}, "kind":{"type":"string"},"alias":{"type":"string"}}, "required":["t","kind","alias"]}
        ]
      }
    }
  }
}

5.2 运行结果记录（SQLite 建议）

CREATE TABLE runs(
  id INTEGER PRIMARY KEY, test_id TEXT, profile_version TEXT,
  status TEXT, start_ts TEXT, end_ts TEXT, trace_path TEXT, notes TEXT
);
CREATE TABLE run_steps(
  id INTEGER PRIMARY KEY, run_id INTEGER, idx INTEGER, step_json TEXT,
  status TEXT, duration_ms INTEGER, screenshot_path TEXT, error TEXT,
  FOREIGN KEY(run_id) REFERENCES runs(id)
);
CREATE TABLE artifacts(
  id INTEGER PRIMARY KEY, run_id INTEGER, kind TEXT, path TEXT,
  meta_json TEXT, FOREIGN KEY(run_id) REFERENCES runs(id)
);


⸻

6. 开发路线（建议）
	•	里程碑 M1（1–2 周）：
	•	执行器跑通 DSL；Trace 产出；结果入库与简单报告页。
	•	里程碑 M2（2–3 周）：
	•	标定工具：iframe 预览 + DOM 面板 + 拾取定位器 + alias 保存；一键校验。
	•	里程碑 M3（1–2 周）：
	•	编译器：自然语言/DSL → ActionPlan；Schema 校验 + 重试；最小提示词与模板。
	•	里程碑 M4（1–2 周）：
	•	报告查看器：运行列表/详情、Trace 链接、失败归因视图；Profile 差异对比。

⸻

7. 风险与对策（直说）
	•	定位器脆弱：优先 role/label/testId；编辑器内置唯一性校验与截图对照。
	•	登录/权限墙：支持 storageState；引入“前置动作”机制。
	•	LLM 编译质量波动：强制 JSON Schema；失败自动最小修复/重试；保留人工审阅入口。
	•	Trace 体积：on-first-retry；定期清理策略；bundle 导出只留失败样本。

⸻

8. 附：最小用例示例（人写给编译器）

用例：买家登录并查看购物车金额
Given 我在登录页，输入邮箱 qa@example.com 和密码 pass1234 并点击登录
When 我访问 /cart
Then 我能看到“购物车”标题，且总价是货币格式