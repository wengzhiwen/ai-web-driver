<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>标定工具 Web GUI MVP</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/calibration.css') }}" rel="stylesheet">
</head>
<body>
    <!-- 顶部导航栏 -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <i class="bi bi-crosshair2"></i>
                标定工具 Web GUI MVP
            </a>
            <div class="navbar-nav ms-auto">
                <button class="btn btn-outline-light btn-sm" id="clearCacheBtn">
                    <i class="bi bi-trash"></i> 清理缓存
                </button>
                <button class="btn btn-outline-light btn-sm" id="debugInfoBtn">
                    <i class="bi bi-bug"></i> 调试信息
                </button>
            </div>
        </div>
    </nav>

    <!-- URL 输入区域 -->
    <div class="container-fluid mt-3">
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="bi bi-window-stack"></i>
                            会话管理
                        </h5>
                    </div>
                    <div class="card-body">
                        <form id="loadPageForm" class="row g-3">
                            <div class="col-md-6">
                                <label for="urlInput" class="form-label">目标 URL</label>
                                <input type="url" class="form-control" id="urlInput"
                                       placeholder="https://example.com" required>
                                <div class="form-text">输入要标定的页面 URL</div>
                            </div>
                            <div class="col-md-3">
                                <label for="viewportWidth" class="form-label">视窗宽度</label>
                                <input type="number" class="form-control" id="viewportWidth"
                                       value="1280" min="800" max="1920">
                            </div>
                            <div class="col-md-3">
                                <label for="viewportHeight" class="form-label">视窗高度</label>
                                <input type="number" class="form-control" id="viewportHeight"
                                       value="720" min="600" max="1080">
                            </div>
                            <div class="col-12">
                                <div class="btn-group">
                                    <button type="submit" class="btn btn-primary" id="loadPageBtn">
                                        <i class="bi bi-window-plus"></i>
                                        启动会话
                                    </button>
                                    <button type="button" class="btn btn-secondary" id="syncDomBtn" disabled>
                                        <i class="bi bi-arrow-clockwise"></i>
                                        同步 DOM
                                    </button>
                                    <button type="button" class="btn btn-outline-danger" id="closeSessionBtn" disabled>
                                        <i class="bi bi-x-square"></i>
                                        关闭会话
                                    </button>
                                </div>
                                <div class="ms-3 d-inline" id="loadingStatus" style="display: none;">
                                    <div class="spinner-border spinner-border-sm" role="status">
                                        <span class="visually-hidden">加载中...</span>
                                    </div>
                                    <span class="ms-2">正在启动会话...</span>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 主要内容区域 -->
    <div class="container-fluid mt-3" id="mainContent" style="display: none;">
        <div class="row">
            <!-- 左侧：页面展示 -->
            <div class="col-lg-7">
                <div class="card h-100">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="bi bi-window"></i>
                            页面预览
                        </h5>
                        <span class="badge bg-secondary" id="sessionInfo"></span>
                    </div>
                    <div class="card-body p-0">
                        <div class="page-preview-container">
                            <iframe id="pageFrame" class="page-frame"></iframe>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 右侧：标定面板 -->
            <div class="col-lg-5">
                <div class="card h-100">
                    <div class="card-header">
                        <!-- Nav tabs -->
                        <ul class="nav nav-tabs card-header-tabs" id="calibrationTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="dom-tab" data-bs-toggle="tab"
                                        data-bs-target="#dom-pane" type="button" role="tab">
                                    <i class="bi bi-code-slash"></i> DOM 树
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="a11y-tab" data-bs-toggle="tab"
                                        data-bs-target="#a11y-pane" type="button" role="tab">
                                    <i class="bi bi-universal-access"></i> A11y 树
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="elements-tab" data-bs-toggle="tab"
                                        data-bs-target="#elements-pane" type="button" role="tab">
                                    <i class="bi bi-list-check"></i> 标定列表
                                    <span class="badge bg-primary ms-1" id="elementCount">0</span>
                                </button>
                            </li>
                        </ul>
                    </div>
                    <div class="card-body">
                        <!-- Tab panes -->
                        <div class="tab-content" id="calibrationTabContent">
                            <!-- DOM 树标签页 -->
                            <div class="tab-pane fade show active" id="dom-pane" role="tabpanel">
                                <div class="mb-3">
                                    <input type="text" class="form-control form-control-sm"
                                           id="domSearchInput" placeholder="搜索 DOM 节点...">
                                </div>
                                <div id="domTree" class="tree-container"></div>
                            </div>

                            <!-- A11y 树标签页 -->
                            <div class="tab-pane fade" id="a11y-pane" role="tabpanel">
                                <div class="mb-3">
                                    <input type="text" class="form-control form-control-sm"
                                           id="a11ySearchInput" placeholder="搜索可访问性节点...">
                                </div>
                                <div id="a11yTree" class="tree-container"></div>
                            </div>

                            <!-- 标定列表标签页 -->
                            <div class="tab-pane fade" id="elements-pane" role="tabpanel">
                                <div class="mb-3">
                                    <button class="btn btn-success btn-sm" data-bs-toggle="modal"
                                            data-bs-target="#saveProfileModal">
                                        <i class="bi bi-save"></i> 保存 Site Profile
                                    </button>
                                </div>
                                <div id="calibrationList" class="calibration-list">
                                    <div class="text-muted text-center py-4">
                                        <i class="bi bi-inbox display-4"></i>
                                        <p class="mt-2">暂无标定元素</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 节点信息模态框 -->
    <div class="modal fade" id="nodeModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">节点信息与标定</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="calibrationForm">
                        <!-- 节点基本信息 -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">标签</label>
                                <input type="text" class="form-control" id="nodeTag" readonly>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">DOM ID</label>
                                <input type="text" class="form-control" id="nodeDomId" readonly>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">类名</label>
                                <input type="text" class="form-control" id="nodeClass" readonly>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">角色</label>
                                <input type="text" class="form-control" id="nodeRole" readonly>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">文本内容</label>
                            <textarea class="form-control" id="nodeText" rows="2" readonly></textarea>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">DOM 路径</label>
                            <input type="text" class="form-control" id="nodePath" readonly>
                        </div>

                        <!-- 标定信息 -->
                        <hr>
                        <h6>标定信息</h6>

                        <div class="mb-3">
                            <label class="form-label">别名 *</label>
                            <input type="text" class="form-control" id="elementAlias" required
                                   placeholder="例如: search.input">
                            <div class="form-text">元素的唯一标识符</div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">描述</label>
                            <textarea class="form-control" id="elementDescription" rows="2"
                                      placeholder="元素的自然语言描述"></textarea>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">定位策略</label>
                            <div class="btn-group" role="group">
                                <input type="radio" class="btn-check" name="locatorStrategy"
                                       id="strategyDomPath" value="dom_path" checked>
                                <label class="btn btn-outline-primary" for="strategyDomPath">DOM 路径</label>

                                <input type="radio" class="btn-check" name="locatorStrategy"
                                       id="strategyDataTest" value="data_test">
                                <label class="btn btn-outline-primary" for="strategyDataTest">Data Test</label>

                                <input type="radio" class="btn-check" name="locatorStrategy"
                                       id="strategyIdClass" value="id_class">
                                <label class="btn btn-outline-primary" for="strategyIdClass">ID/Class</label>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">选择器</label>
                            <input type="text" class="form-control" id="elementSelector" required>
                            <div class="form-text">用于定位元素的选择器</div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" id="addElementBtn">
                        <i class="bi bi-plus-circle"></i> 添加到标定列表
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 保存 Site Profile 模态框 -->
    <div class="modal fade" id="saveProfileModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">保存 Site Profile</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="saveProfileForm">
                        <div class="mb-3">
                            <label class="form-label">站点名称 *</label>
                            <input type="text" class="form-control" id="siteName" required>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">站点 Base URL</label>
                            <input type="url" class="form-control" id="siteBaseUrl">
                            <div class="form-text">站点的根 URL，可选</div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">页面 ID *</label>
                            <input type="text" class="form-control" id="pageId" required>
                            <div class="form-text">页面的唯一标识符</div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">URL 模式</label>
                            <input type="text" class="form-control" id="urlPattern">
                            <div class="form-text">页面的 URL 匹配模式，可选</div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">页面描述</label>
                            <textarea class="form-control" id="pageSummary" rows="3"
                                      placeholder="页面的功能描述"></textarea>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">备注</label>
                            <textarea class="form-control" id="pageNotes" rows="2"
                                      placeholder="额外的备注信息"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-success" id="saveProfileBtn">
                        <i class="bi bi-save"></i> 保存
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 调试信息模态框 -->
    <div class="modal fade" id="debugModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">调试信息</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="debugContent">
                        <!-- 调试信息将在这里动态填充 -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 错误提示 -->
    <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
        <div id="errorToast" class="toast" role="alert">
            <div class="toast-header bg-danger text-white">
                <i class="bi bi-exclamation-triangle-fill me-2"></i>
                <strong class="me-auto">错误</strong>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast"></button>
            </div>
            <div class="toast-body" id="errorMessage"></div>
        </div>
    </div>

    <!-- 成功提示 -->
    <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
        <div id="successToast" class="toast" role="alert">
            <div class="toast-header bg-success text-white">
                <i class="bi bi-check-circle-fill me-2"></i>
                <strong class="me-auto">成功</strong>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast"></button>
            </div>
            <div class="toast-body" id="successMessage"></div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{{ url_for('static', filename='js/calibration.js') }}"></script>
</body>
</html>